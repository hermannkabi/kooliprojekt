{% extends 'base.html' %}
{% load static %}

{% block head %}
    <title>{{lesson.title}} | {{course.title}}</title>
    <link rel="stylesheet" href="{% static 'lesson.css' %}">
{% endblock %}

{% block title %}
<div class="two-row-nav-title">
    <h1>{{ lesson.title }}</h1>
    <p style="cursor: pointer;" onclick="window.location.href = '{% url 'course' id=course.id %}'" class="secondary">{{ course.title }}</p>
</div>
{% endblock %}


{% block content %}
 
    <div class="lesson-content">
        {% block lesson %}
        
        {% endblock%}
    </div>
    <br><br><br>
    <div class="popup error not-dismissable" id="cannotFinishLesson" hidden>
        <span>Tundi ei saa lÃµpetada, sest Ã¼lesanded on Ãµigesti tegemata</span>
    </div>
    <div class="lesson-end">
        {% if not isComplete %}
            
            <button onclick="onFinishLesson()" class="filled"><i class="material-icons">check_circle</i> &nbsp;  LÃµpeta tund</button>
        {% else %}
            <a href="{% url 'index' %}" class="link-button filled"><i class="material-icons">arrow_back</i> &nbsp;  Tagasi</a> 
            <button onclick="window.location.href = '{% url 'removeLesson' id=lesson.id %}'" class="outlined">Eemalda tehtute hulgast</button>            
        {% endif %}
    </div>
    <br><br>

    <style>
        .question-card-front, .question-card-back{
            transition: all 200ms;
        }

        .question-load-div{
            transition: height 200ms;
        }
    </style>


    <script>
        function onFinishLesson(){
            if($(".question-undone").length){
                $("#cannotFinishLesson").css("display", "block").fadeIn(200);
                $(".question-undone .error-text").show();
                $(".question-undone").get(0).scrollIntoView({behavior: 'smooth'});
            }else{
                setTimeout(() => {
                    window.location.href = '{% url 'finishLesson' id=lesson.id %}';
                }, 200);
            }
        }
    </script>
    <script>
        var align = "left";
        $(".question-load-div").each(function (){
            var id = $(this).attr("question-id");

            var url = "{% url 'exercise' id=12345 %}".replace(/12345/, id.toString());

            console.log(url);

            $(this).load(url, function (){
                $(this).addClass("question-undone");
            });

        });
        
        setTimeout(() => {
            // For correctly rendering MathJax
            MathJax.Hub.Typeset();
            
            let checker = (arr, target) => target.every(v => arr.includes(v)) && target.length > 0;
            let someChecker = (arr, target) => target.some(v => arr.includes(v)) && target.length > 0;


            $(".question-submit-btn").click(function (){
                var questionId = $(this).attr("question-id");

                

                var choices = $(".question-choices[question-id="+questionId.toString() + "]");

                var answers = [];
                var correctAnswers = [];

                choices.children().each(function (){
                    if($(this).attr("isCorrect") == "true"){
                        correctAnswers.push($(this).attr("choiceId").toString().toLowerCase());
                    }
                    var isChecked = $(this).children().is(":checked");
                    if(isChecked){
                        answers.push($(this).attr("choiceId"));
                    }

                    $(this).children().prop("checked", false);
                });


                var result;


                if($(".question-write[question-id=" + questionId.toString() + "]").length){
                    // Write answer
                    if(correctAnswers.includes($(".question-write[question-id=" + questionId.toString() + "]").val().toLowerCase())){
                        result = "ðŸŽ‰ Ã•ige vastus!";
                        $(".question-load-div[question-id=" + questionId.toString() + "]").removeClass("question-undone");
                        $(".question-load-div[question-id=" + questionId.toString() + "] .error-text").hide();
                    }else{
                        result = "ðŸ‘Ž Vale vastus!";
                    }
                }else if($("input[type='range'][question-id=" + questionId.toString() + "]").length){
                    var correctMin = parseInt($("input[type='range'][question-id=" + questionId.toString() + "]").attr("correct-min"));
                    var correctMax = parseInt($("input[type='range'][question-id=" + questionId.toString() + "]").attr("correct-max"));

                    var answer = parseInt($("input[type='range'][question-id=" + questionId.toString() + "]").val());

                    if(correctMin <= answer && answer <= correctMax){
                        result = "ðŸŽ‰ Ã•ige vastus!";
                        $(".question-load-div[question-id=" + questionId.toString() + "]").removeClass("question-undone");
                        $(".question-load-div[question-id=" + questionId.toString() + "] .error-text").hide();
                    }else{
                        result = "ðŸ‘Ž Vale vastus!";
                    }

                }else{

                    //Not write answer
                    if(checker(correctAnswers, answers)){
                        result = "ðŸŽ‰ Ã•ige vastus!";
                        $(".question-load-div[question-id=" + questionId.toString() + "]").removeClass("question-undone");
                        $(".question-load-div[question-id=" + questionId.toString() + "] .error-text").hide();
                        
                    }else if(someChecker(answers, correctAnswers)){
                        result = "ðŸ˜ Pooleldi Ãµige!";
                    }else{
                        result = "ðŸ‘Ž Vale vastus!";
                    }
                }

                

                $(".question-card-back > .question-result[question-id=" + questionId.toString() + "]").text(result);

                $(".question-load-div[question-id=" + questionId.toString() + "] .question > .question-card-front").css("opacity", "0");

                

                setTimeout(() => {
                    $(".question-load-div[question-id=" + questionId.toString() + "] .question > .question-card-front").css("display", "none");
                    $(".question-load-div[question-id=" + questionId.toString() + "] .question > .question-card-back").css("opacity", "0");

                    $(".question-load-div[question-id=" + questionId.toString() + "] .question > .question-card-back").css("display", "block");

                    $(".question-load-div[question-id=" + questionId.toString() + "] .question > .question-card-back").css("opacity", "1");
                }, 200);



            });

            $(".explanation-btn").click(function (){
                var questionId = $(this).attr("question-id");
                $(".explanation[question-id=" + questionId.toString() + "]").toggle();
                if($(".explanation[question-id=" + questionId.toString() + "]").is(":visible")){
                    $(this).text("Peida selgitus")
                }else{
                    $(this).text("Vaata selgitust")
                }
            });

            $(".try-again-btn").click(function (){
                var questionId = $(this).attr("question-id");
                $(".question-load-div[question-id=" + questionId.toString() + "] .question > .question-card-back").css("opacity", "0");
                setTimeout(() => {
                    $(".explanation-btn[question-id="+questionId+"]").text("Vaata selgitust!");

                    $(".question-load-div[question-id=" + questionId.toString() + "] .question > .question-card-back").css("display", "none");
                    $(".question-load-div[question-id=" + questionId.toString() + "] .question > .question-card-front").css("display", "block");
                    $(".explanation[question-id=" + questionId.toString() + "]").hide();

                    $(".question-load-div[question-id=" + questionId.toString() + "] .question > .question-card-front").css("opacity", "1");
                }, 200);
            });

            
            $("input[type='range']").on("change mousemove", function (){
                $(".range-value[question-id="+ $(this).attr("question-id") +"]").text($(this).val().toString());
            });
        }, 1000);

    </script>

{% endblock %}